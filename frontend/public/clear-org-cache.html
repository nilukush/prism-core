<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Organization Cache - PRISM</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #1f2937;
            font-size: 24px;
            margin-bottom: 10px;
        }
        p {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2563eb;
        }
        button.secondary {
            background-color: #6b7280;
        }
        button.secondary:hover {
            background-color: #4b5563;
        }
        .status {
            margin-top: 20px;
            padding: 16px;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .log {
            text-align: left;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 4px 0;
        }
        .log-entry.success {
            color: #059669;
        }
        .log-entry.error {
            color: #dc2626;
        }
        .log-entry.info {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧹 Clear Organization Cache</h1>
        <p>
            If you're experiencing issues with organization creation or the modal not showing,
            this tool will clear any cached data that might be causing problems.
        </p>
        
        <button onclick="clearAllCache()">Clear All Cache</button>
        <button onclick="checkStatus()" class="secondary">Check Current Status</button>
        
        <div id="status"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const showStatus = (message, type = 'success') => {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        };

        const clearAllCache = async () => {
            try {
                log('Starting cache clear process...', 'info');
                
                // Clear localStorage
                const localStorageKeys = Object.keys(localStorage);
                log(`Found ${localStorageKeys.length} localStorage items`, 'info');
                
                // Save auth token if exists
                const token = localStorage.getItem('token');
                const nextAuthSession = localStorage.getItem('next-auth.session-token');
                
                // Clear all localStorage
                localStorage.clear();
                log('Cleared localStorage', 'success');
                
                // Restore auth tokens
                if (token) {
                    localStorage.setItem('token', token);
                    log('Restored auth token', 'info');
                }
                if (nextAuthSession) {
                    localStorage.setItem('next-auth.session-token', nextAuthSession);
                    log('Restored NextAuth session', 'info');
                }
                
                // Clear sessionStorage
                const sessionStorageKeys = Object.keys(sessionStorage);
                log(`Found ${sessionStorageKeys.length} sessionStorage items`, 'info');
                sessionStorage.clear();
                log('Cleared sessionStorage', 'success');
                
                // Clear cookies (limited to what JavaScript can access)
                document.cookie.split(";").forEach(function(c) { 
                    const eqPos = c.indexOf("=");
                    const name = eqPos > -1 ? c.substr(0, eqPos).trim() : c.trim();
                    if (name && !name.includes('next-auth')) {
                        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                        log(`Cleared cookie: ${name}`, 'info');
                    }
                });
                
                // Try to clear Next.js cache
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`Found ${cacheNames.length} service worker caches`, 'info');
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`Deleted cache: ${cacheName}`, 'success');
                    }
                }
                
                // Clear any React Query cache if it exists
                if (window.__REACT_QUERY_STATE__) {
                    delete window.__REACT_QUERY_STATE__;
                    log('Cleared React Query cache', 'success');
                }
                
                showStatus('✅ Cache cleared successfully! Redirecting to login...', 'success');
                log('Cache clear complete! Redirecting in 3 seconds...', 'success');
                
                // Redirect to login after 3 seconds
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 3000);
                
            } catch (error) {
                console.error('Error clearing cache:', error);
                log(`Error: ${error.message}`, 'error');
                showStatus('❌ Error clearing cache. Check the log for details.', 'error');
            }
        };

        const checkStatus = () => {
            log('Checking current status...', 'info');
            
            // Check localStorage
            const localStorageItems = Object.keys(localStorage);
            log(`localStorage items: ${localStorageItems.length}`, 'info');
            localStorageItems.forEach(key => {
                const value = localStorage.getItem(key);
                const preview = value && value.length > 50 ? value.substring(0, 50) + '...' : value;
                log(`  - ${key}: ${preview}`, 'info');
            });
            
            // Check sessionStorage
            const sessionStorageItems = Object.keys(sessionStorage);
            log(`sessionStorage items: ${sessionStorageItems.length}`, 'info');
            sessionStorageItems.forEach(key => {
                const value = sessionStorage.getItem(key);
                const preview = value && value.length > 50 ? value.substring(0, 50) + '...' : value;
                log(`  - ${key}: ${preview}`, 'info');
            });
            
            // Check cookies
            const cookies = document.cookie.split(';');
            log(`Cookies: ${cookies.length}`, 'info');
            cookies.forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name) {
                    const preview = value && value.length > 50 ? value.substring(0, 50) + '...' : value;
                    log(`  - ${name}: ${preview}`, 'info');
                }
            });
            
            // Check for specific PRISM data
            const hasOrgData = localStorageItems.some(key => key.includes('org') || key.includes('organization'));
            const hasProjectData = localStorageItems.some(key => key.includes('project'));
            
            if (hasOrgData || hasProjectData) {
                log('⚠️ Found organization or project data in cache', 'error');
                showStatus('⚠️ Found cached data that might interfere with organization creation', 'error');
            } else {
                log('✅ No organization or project data found in cache', 'success');
                showStatus('✅ Cache looks clean', 'success');
            }
        };

        // Auto-check status on load
        window.addEventListener('load', () => {
            log('Page loaded - ready to clear cache', 'info');
        });
    </script>
</body>
</html>